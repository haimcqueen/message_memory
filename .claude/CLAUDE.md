# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

WhatsApp Message Memory is a production-ready FastAPI system that logs all WhatsApp messages from a business account to Supabase. It processes text, voice, images, videos, and documents with automatic transcription, PDF/image parsing, and intelligent message batching for n8n workflows.

## Development Commands

### Environment Setup
```bash
# Install uv package manager
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install dependencies
uv sync

# Set up environment variables
cp .env.example .env
# Edit .env with actual credentials
```

### Running Services (requires 3 terminals)

**Terminal 1 - Redis:**
```bash
redis-server
```

**Terminal 2 - FastAPI Server:**
```bash
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**Terminal 3 - RQ Worker:**
```bash
./run_worker.sh
# or
uv run rq worker whatsapp-messages --url redis://localhost:6379 --with-scheduler
```

### Testing

**Run all tests:**
```bash
uv run pytest
```

**Run specific test categories:**
```bash
uv run pytest -m unit           # Unit tests only
uv run pytest -m integration    # Integration tests only
uv run pytest -k test_jobs      # Tests matching pattern
```

**Run single test file:**
```bash
uv run pytest tests/unit/test_jobs.py
```

**Run with coverage:**
```bash
uv run pytest --cov=workers --cov=app --cov=utils --cov-report=html
```

### Monitoring & Debugging

**Check RQ queue status:**
```bash
uv run rq info --url redis://localhost:6379
```

**Test webhooks locally:**
```bash
# Expose local server with ngrok
ngrok http 8000
# Configure Whapi webhook to: https://abc123.ngrok.io/webhook/whapi
```

**Manual retry of failed jobs:**
```bash
uv run python -m workers.retry_pending
```

## Architecture

### Request Flow

1. **Webhook Receipt** (`app/main.py`)
   - FastAPI receives Whapi webhook at `/webhook/whapi`
   - Validates Bearer token (currently disabled in code)
   - Immediately queues message to RQ and returns 200 OK

2. **Background Processing** (`workers/jobs.py`)
   - RQ worker picks up job from `whatsapp-messages` queue
   - Determines message origin: "agent" (from_me=true) vs "user" (from_me=false)
   - Processes message based on type (text, voice, image, video, document, audio)
   - Looks up internal user_id from users table by phone number
   - **Rejects messages from unknown phone numbers** (not in users table)

3. **Media Processing** (`workers/media.py`)
   - Downloads media from Whapi API
   - Uploads to Supabase Storage bucket `whatsapp-media`
   - For PDFs: Extracts text using OpenAI Vision API (gpt-5.1-2025-11-13)
   - For images: Can extract content using OpenAI Vision API
   - Enforces 50MB file size limit (configurable via MAX_FILE_SIZE_MB)

4. **Voice Transcription** (`workers/transcription.py`)
   - Downloads voice message from Whapi
   - Uploads to Supabase Storage
   - Transcribes with OpenAI Whisper API (whisper-1)

5. **Onboarding Call Transcription** (`workers/transcription_elevenlabs.py`)
   - Triggered via `POST /webhook/transcribe` endpoint
   - Supports dual recording (mic + system audio) and IRL (single file with diarization)
   - Downloads recordings from Supabase Storage
   - Combines stereo audio using ffmpeg (preserves full duration of longest input)
   - Transcribes with ElevenLabs Scribe v1 (multichannel or diarization mode)
   - Uses sentence-level stitching to prevent choppy output from overlapping speech
   - Appends transcripts to `onboarding_information` table (with `---` separator)
   - Notifies n8n on completion

6. **Database Storage** (`workers/database.py`)
   - Inserts message into `messages` table with UUID
   - Stores original Whapi message ID in `whapi_message_id` field
   - For PDFs: parsed content stored in `extracted_media_content` field
   - If processing fails: creates entry in `message_processing_jobs` table for retry

6. **Message Batching** (`workers/batching.py`)
   - Only user messages (from_me=false) are batched
   - Increments counter in Redis for each user message
   - Schedules/reschedules n8n forward job (default: 60s delay)
   - After delay: forwards batch to n8n with `user_id` and `batched_message_count`

7. **n8n Integration** (`workers/n8n_forwarder.py`)
   - Sends batch summary to n8n webhook
   - Payload: `{"user_id": "uuid", "batched_message_count": N}`
   - Uses Bearer token authentication
   - Has retry logic (2 attempts with exponential backoff)

8. **Error Handling**
   - Failed media/voice processing creates entry in `message_processing_jobs` table
   - Retry worker (`workers/retry_pending.py`) can reprocess failed jobs
   - n8n error webhook (`/webhook/n8n-error`) sends alerts to admin WhatsApp

### Key Data Models

**Messages Table Schema:**
- `id` (UUID, primary key) - Generated by this app
- `user_id` (UUID, foreign key to users table) - Internal user ID
- `content` (text) - Message text or transcription
- `origin` (enum: "agent" | "user") - Message direction
- `type` (text) - Message type (text, voice, image, video, document, audio, link_preview)
- `message_sent_at` (timestamp) - When message was actually sent
- `chat_id` (text) - WhatsApp chat ID (format: "4915202618514@s.whatsapp.net")
- `media_url` (text, nullable) - Supabase Storage URL
- `whapi_message_id` (text, unique) - Original Whapi message ID
- `extracted_media_content` (text, nullable) - Parsed PDF/image content

**Processing Jobs Table:**
- Tracks failed message processing for retry
- Fields: `message_id`, `status`, `retry_count`, `webhook_payload`, `error_message`

**Users Table (external):**
- Must exist with at least `id` and `phone` columns
- Used for phone number â†’ user_id lookup

### Important Behaviors

1. **User Validation:** Messages from phone numbers NOT in the users table are rejected with a notification and NOT stored in the database.

2. **File Size Limits:** Media files over 50MB (configurable) are rejected with unified message: "We don't support media of this size"

3. **Duplicate Prevention:** Duplicate `whapi_message_id` values are silently skipped (unique constraint)

4. **Presence Indicators:** Sends "typing" presence to users for their messages (configurable duration: 13-18s)

5. **Batch Timing:** Message batching waits N seconds (default 60) after LAST message before forwarding to n8n

6. **Agent Messages:** Messages from the agent (from_me=true) are NOT batched to n8n

7. **Short Videos:** WhatsApp "short" (reels) messages are mapped to "video" type for storage

### External Dependencies

- **Supabase:** Database + Storage (requires service_role key)
- **Whapi.cloud:** WhatsApp Business API provider
- **OpenAI:** Whisper API for voice transcription, GPT-5.1 for PDF/image extraction
- **Redis:** Job queue and batching state
- **n8n:** Workflow automation (receives batched message notifications)

### Error Handling Patterns

All external API calls use `tenacity` retry decorators:
- **Whisper API:** 5 attempts, 2s-32s backoff
- **Supabase Operations:** 3 attempts, 1s-8s backoff
- **Media Download/Upload:** 3 attempts, 1s-8s backoff
- **PDF Extraction:** 3 attempts, 2s-16s backoff
- **n8n Forward:** 2 attempts, 2s-10s backoff

### Deployment

This project uses Railway for deployment (see `Procfile` and `railway.json`):

- **web process:** Runs FastAPI with `uvicorn app.main:app`
- **worker process:** Runs RQ worker with scheduler (`--with-scheduler` flag)

Environment variables must be configured in Railway dashboard (see `.env.example`).

## Common Development Tasks

### Branch Management
- Always pull from GitHub main before creating a new branch
- Create a new branch for each feature or fix
- Do not add "created by claude code" or similar attribution in commit/PR messages

### Adding New Message Types
1. Update `workers/jobs.py` to handle new type in message processing
2. Add processing logic in appropriate worker module
3. Update `app/models.py` if webhook schema changes
4. Run migrations if database schema changes needed

### Database Migrations
Execute SQL files in `migrations/` directory using Supabase SQL Editor in numerical order.

### Testing Media Processing
Use `/webhook/debug` endpoint to inspect raw webhook payloads without processing.

### Monitoring Failed Jobs
Query Supabase: `SELECT * FROM message_processing_jobs WHERE status = 'failed' ORDER BY created_at DESC;`
